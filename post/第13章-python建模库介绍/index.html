<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title> - Yang Xu&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Yang Xu" /><meta name="description" content="本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。" /><meta name="keywords" content="生活, 学习, 工作" />






<meta name="generator" content="Hugo 0.68.3 with theme even" />


<link rel="canonical" href="https://xy19950225.github.io/hugo-blog/post/%E7%AC%AC13%E7%AB%A0-python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/" />
<link rel="apple-touch-icon" sizes="180x180" href="/hugo-blog/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/hugo-blog/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/hugo-blog/favicon-16x16.png">
<link rel="manifest" href="/hugo-blog/manifest.json">
<link rel="mask-icon" href="/hugo-blog/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/hugo-blog/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="" />
<meta property="og:description" content="本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xy19950225.github.io/hugo-blog/post/%E7%AC%AC13%E7%AB%A0-python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。">

<meta itemprop="wordCount" content="7182">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/hugo-blog/" class="logo">Yang Xu&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/hugo-blog/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/hugo-blog/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/hugo-blog/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/hugo-blog/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/hugo-blog/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/hugo-blog/" class="logo">Yang Xu&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/hugo-blog/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/hugo-blog/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/hugo-blog/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/hugo-blog/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/hugo-blog/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title"></h1>

      <div class="post-meta">
        <span class="post-time"> 0001-01-01 </span>
        
          <span class="more-meta"> 约 7182 字 </span>
          <span class="more-meta"> 预计阅读 15 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/hugo-blog/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#131-pandas与模型代码的接口">13.1 pandas与模型代码的接口</a></li>
    <li><a href="#132-用patsy创建模型描述">13.2 用Patsy创建模型描述</a>
      <ul>
        <li><a href="#用patsy公式进行数据转换">用Patsy公式进行数据转换</a></li>
        <li><a href="#分类数据和patsy">分类数据和Patsy</a></li>
      </ul>
    </li>
    <li><a href="#133-statsmodels介绍">13.3 statsmodels介绍</a>
      <ul>
        <li><a href="#估计线性模型">估计线性模型</a></li>
        <li><a href="#估计时间序列过程">估计时间序列过程</a></li>
      </ul>
    </li>
    <li><a href="#134-scikit-learn介绍">13.4 scikit-learn介绍</a></li>
    <li><a href="#135-继续学习">13.5 继续学习</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="0001-01-01T00:00:00" title="January 1, 0001">January 1, 0001</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <p>本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。</p>
<p>开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。</p>
<p>本章中，我会回顾一些pandas的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，statsmodels和scikit-learn。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。</p>
<h1 id="131-pandas与模型代码的接口">13.1 pandas与模型代码的接口</h1>
<p>模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。</p>
<p>优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。</p>
<p>pandas与其它分析库通常是靠NumPy的数组联系起来的。将DataFrame转换为NumPy数组，可以使用.values属性：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">]})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">data</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">13</span><span class="p">]:</span> 
   <span class="n">x0</span>    <span class="n">x1</span>    <span class="n">y</span>
<span class="mi">0</span>   <span class="mi">1</span>  <span class="mf">0.01</span> <span class="o">-</span><span class="mf">1.5</span>
<span class="mi">1</span>   <span class="mi">2</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="mf">0.0</span>
<span class="mi">2</span>   <span class="mi">3</span>  <span class="mf">0.25</span>  <span class="mf">3.6</span>
<span class="mi">3</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">4.10</span>  <span class="mf">1.3</span>
<span class="mi">4</span>   <span class="mi">5</span>  <span class="mf">0.00</span> <span class="o">-</span><span class="mf">2.0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">Index</span><span class="p">([</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">2.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>  <span class="mf">0.</span>  <span class="p">],</span>
       <span class="p">[</span> <span class="mf">3.</span>  <span class="p">,</span>  <span class="mf">0.25</span><span class="p">,</span>  <span class="mf">3.6</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">4.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span> <span class="p">,</span>  <span class="mf">1.3</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">5.</span>  <span class="p">,</span>  <span class="mf">0.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">2.</span>  <span class="p">]])</span>
</code></pre></td></tr></table>
</div>
</div><p>要转换回DataFrame，可以传递一个二维ndarray，可带有列名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="n">df2</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span> 
   <span class="n">one</span>   <span class="n">two</span>  <span class="n">three</span>
<span class="mi">0</span>  <span class="mf">1.0</span>  <span class="mf">0.01</span>   <span class="o">-</span><span class="mf">1.5</span>
<span class="mi">1</span>  <span class="mf">2.0</span> <span class="o">-</span><span class="mf">0.01</span>    <span class="mf">0.0</span>
<span class="mi">2</span>  <span class="mf">3.0</span>  <span class="mf">0.25</span>    <span class="mf">3.6</span>
<span class="mi">3</span>  <span class="mf">4.0</span> <span class="o">-</span><span class="mf">4.10</span>    <span class="mf">1.3</span>
<span class="mi">4</span>  <span class="mf">5.0</span>  <span class="mf">0.00</span>   <span class="o">-</span><span class="mf">2.0</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>笔记：最好当数据是均匀的时候使用.values属性。例如，全是数值类型。如果数据是不均匀的，结果会是Python对象的ndarray：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">18</span><span class="p">]:</span> <span class="n">df3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">df3</span><span class="p">[</span><span class="s1">&#39;strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="n">df3</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">20</span><span class="p">]:</span> 
  <span class="n">x0</span>    <span class="n">x1</span>    <span class="n">y</span> <span class="n">strings</span>
<span class="mi">0</span>   <span class="mi">1</span>  <span class="mf">0.01</span> <span class="o">-</span><span class="mf">1.5</span>       <span class="n">a</span>
<span class="mi">1</span>   <span class="mi">2</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="mf">0.0</span>       <span class="n">b</span>
<span class="mi">2</span>   <span class="mi">3</span>  <span class="mf">0.25</span>  <span class="mf">3.6</span>       <span class="n">c</span>
<span class="mi">3</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">4.10</span>  <span class="mf">1.3</span>       <span class="n">d</span>
<span class="mi">4</span>   <span class="mi">5</span>  <span class="mf">0.00</span> <span class="o">-</span><span class="mf">2.0</span>       <span class="n">e</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">df3</span><span class="o">.</span><span class="n">values</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">21</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
      <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span>
      <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span>
      <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
      <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>对于一些模型，你可能只想使用列的子集。我建议你使用loc，用values作索引：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="n">model_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">model_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">23</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">0.01</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">2.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">3.</span>  <span class="p">,</span>  <span class="mf">0.25</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">4.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">5.</span>  <span class="p">,</span>  <span class="mf">0.</span>  <span class="p">]])</span>
</code></pre></td></tr></table>
</div>
</div><p>一些库原生支持pandas，会自动完成工作：从DataFrame转换到NumPy，将模型的参数名添加到输出表的列或Series。其它情况，你可以手工进行“元数据管理”。</p>
<p>在第12章，我们学习了pandas的Categorical类型和pandas.get_dummies函数。假设数据集中有一个非数值列：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>                                   <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="n">data</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">25</span><span class="p">]:</span> 
   <span class="n">x0</span>    <span class="n">x1</span>    <span class="n">y</span> <span class="n">category</span>
<span class="mi">0</span>   <span class="mi">1</span>  <span class="mf">0.01</span> <span class="o">-</span><span class="mf">1.5</span>        <span class="n">a</span>
<span class="mi">1</span>   <span class="mi">2</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="mf">0.0</span>        <span class="n">b</span>
<span class="mi">2</span>   <span class="mi">3</span>  <span class="mf">0.25</span>  <span class="mf">3.6</span>        <span class="n">a</span>
<span class="mi">3</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">4.10</span>  <span class="mf">1.3</span>        <span class="n">a</span>
<span class="mi">4</span>   <span class="mi">5</span>  <span class="mf">0.00</span> <span class="o">-</span><span class="mf">2.0</span>        <span class="n">b</span>
</code></pre></td></tr></table>
</div>
</div><p>如果我们想替换category列为虚变量，我们可以创建虚变量，删除category列，然后添加到结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="n">dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="n">data_with_dummies</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dummies</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">]:</span> <span class="n">data_with_dummies</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">28</span><span class="p">]:</span> 
   <span class="n">x0</span>    <span class="n">x1</span>    <span class="n">y</span>  <span class="n">category_a</span>  <span class="n">category_b</span>
<span class="mi">0</span>   <span class="mi">1</span>  <span class="mf">0.01</span> <span class="o">-</span><span class="mf">1.5</span>           <span class="mi">1</span>           <span class="mi">0</span>
<span class="mi">1</span>   <span class="mi">2</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="mf">0.0</span>           <span class="mi">0</span>           <span class="mi">1</span>
<span class="mi">2</span>   <span class="mi">3</span>  <span class="mf">0.25</span>  <span class="mf">3.6</span>           <span class="mi">1</span>           <span class="mi">0</span>
<span class="mi">3</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">4.10</span>  <span class="mf">1.3</span>           <span class="mi">1</span>           <span class="mi">0</span>
<span class="mi">4</span>   <span class="mi">5</span>  <span class="mf">0.00</span> <span class="o">-</span><span class="mf">2.0</span>           <span class="mi">0</span>           <span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div><p>用虚变量拟合某些统计模型会有一些细微差别。当你不只有数字列时，使用Patsy（下一节的主题）可能更简单，更不容易出错。</p>
<h1 id="132-用patsy创建模型描述">13.2 用Patsy创建模型描述</h1>
<p>Patsy是Python的一个库，使用简短的字符串“公式语法”描述统计模型（尤其是线性模型），可能是受到了R和S统计编程语言的公式语法的启发。</p>
<p>Patsy适合描述statsmodels的线性模型，因此我会关注于它的主要特点，让你尽快掌握。Patsy的公式是一个特殊的字符串语法，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">y</span> <span class="o">~</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span>
</code></pre></td></tr></table>
</div>
</div><p>a+b不是将a与b相加的意思，而是为模型创建的设计矩阵。patsy.dmatrices函数接收一个公式字符串和一个数据集（可以是DataFrame或数组的字典），为线性模型创建设计矩阵：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">]})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">data</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">30</span><span class="p">]:</span> 
   <span class="n">x0</span>    <span class="n">x1</span>    <span class="n">y</span>
<span class="mi">0</span>   <span class="mi">1</span>  <span class="mf">0.01</span> <span class="o">-</span><span class="mf">1.5</span>
<span class="mi">1</span>   <span class="mi">2</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="mf">0.0</span>
<span class="mi">2</span>   <span class="mi">3</span>  <span class="mf">0.25</span>  <span class="mf">3.6</span>
<span class="mi">3</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">4.10</span>  <span class="mf">1.3</span>
<span class="mi">4</span>   <span class="mi">5</span>  <span class="mf">0.00</span> <span class="o">-</span><span class="mf">2.0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">patsy</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;y ~ x0 + x1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>现在有：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="n">y</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">33</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
     <span class="n">y</span>
  <span class="o">-</span><span class="mf">1.5</span>
   <span class="mf">0.0</span>
   <span class="mf">3.6</span>
   <span class="mf">1.3</span>
  <span class="o">-</span><span class="mf">2.0</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;y&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">34</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">x0</span>     <span class="n">x1</span>
          <span class="mi">1</span>   <span class="mi">1</span>   <span class="mf">0.01</span>
          <span class="mi">1</span>   <span class="mi">2</span>  <span class="o">-</span><span class="mf">0.01</span>
          <span class="mi">1</span>   <span class="mi">3</span>   <span class="mf">0.25</span>
          <span class="mi">1</span>   <span class="mi">4</span>  <span class="o">-</span><span class="mf">4.10</span>
          <span class="mi">1</span>   <span class="mi">5</span>   <span class="mf">0.00</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;x0&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;x1&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这些Patsy的DesignMatrix实例是NumPy的ndarray，带有附加元数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">35</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">3.6</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.3</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">2.</span> <span class="p">]])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">36</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">0.01</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">2.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">3.</span>  <span class="p">,</span>  <span class="mf">0.25</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">4.</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">4.1</span> <span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">5.</span>  <span class="p">,</span>  <span class="mf">0.</span>  <span class="p">]])</span>
</code></pre></td></tr></table>
</div>
</div><p>你可能想Intercept是哪里来的。这是线性模型（比如普通最小二乘回归）的惯例用法。添加 +0 到模型可以不显示intercept：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;y ~ x0 + x1 + 0&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">x0</span>     <span class="n">x1</span>
   <span class="mi">1</span>   <span class="mf">0.01</span>
   <span class="mi">2</span>  <span class="o">-</span><span class="mf">0.01</span>
   <span class="mi">3</span>   <span class="mf">0.25</span>
   <span class="mi">4</span>  <span class="o">-</span><span class="mf">4.10</span>
   <span class="mi">5</span>   <span class="mf">0.00</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;x0&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;x1&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Patsy对象可以直接传递到算法（比如numpy.linalg.lstsq）中，它执行普通最小二乘回归：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">]:</span> <span class="n">coef</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得一个Series，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">coef</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">39</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span> <span class="mf">0.3129</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.0791</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.2655</span><span class="p">]])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">coef</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">41</span><span class="p">]:</span> 
<span class="n">Intercept</span>    <span class="mf">0.312910</span>
<span class="n">x0</span>          <span class="o">-</span><span class="mf">0.079106</span>
<span class="n">x1</span>          <span class="o">-</span><span class="mf">0.265464</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="用patsy公式进行数据转换">用Patsy公式进行数据转换</h2>
<p>你可以将Python代码与patsy公式结合。在评估公式时，库将尝试查找在封闭作用域内使用的函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;y ~ x0 + np.log(np.abs(x1) + 1)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">43</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">x0</span>  <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
          <span class="mi">1</span>   <span class="mi">1</span>                 <span class="mf">0.00995</span>
          <span class="mi">1</span>   <span class="mi">2</span>                 <span class="mf">0.00995</span>
          <span class="mi">1</span>   <span class="mi">3</span>                 <span class="mf">0.22314</span>
          <span class="mi">1</span>   <span class="mi">4</span>                 <span class="mf">1.62924</span>
          <span class="mi">1</span>   <span class="mi">5</span>                 <span class="mf">0.00000</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;x0&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;np.log(np.abs(x1) + 1)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>常见的变量转换包括标准化（平均值为0，方差为1）和中心化（减去平均值）。Patsy有内置的函数进行这样的工作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;y ~ standardize(x0) + center(x1)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">45</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">standardize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>  <span class="n">center</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
          <span class="mi">1</span>         <span class="o">-</span><span class="mf">1.41421</span>        <span class="mf">0.78</span>
          <span class="mi">1</span>         <span class="o">-</span><span class="mf">0.70711</span>        <span class="mf">0.76</span>
          <span class="mi">1</span>          <span class="mf">0.00000</span>        <span class="mf">1.02</span>
          <span class="mi">1</span>          <span class="mf">0.70711</span>       <span class="o">-</span><span class="mf">3.33</span>
          <span class="mi">1</span>          <span class="mf">1.41421</span>        <span class="mf">0.77</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;standardize(x0)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;center(x1)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>作为建模的一步，你可能拟合模型到一个数据集，然后用另一个数据集评估模型。另一个数据集可能是剩余的部分或是新数据。当执行中心化和标准化转变，用新数据进行预测要格外小心。因为你必须使用平均值或标准差转换新数据集，这也称作状态转换。</p>
<p>patsy.build_design_matrices函数可以使用原始样本数据集的保存信息，来转换新数据，：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="n">new_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">47</span><span class="p">]:</span> <span class="n">new_X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">build_design_matrices</span><span class="p">([</span><span class="n">X</span><span class="o">.</span><span class="n">design_info</span><span class="p">],</span> <span class="n">new_data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">48</span><span class="p">]:</span> <span class="n">new_X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">48</span><span class="p">]:</span> 
<span class="p">[</span><span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
   <span class="n">Intercept</span>  <span class="n">standardize</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>  <span class="n">center</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
           <span class="mi">1</span>          <span class="mf">2.12132</span>        <span class="mf">3.87</span>
           <span class="mi">1</span>          <span class="mf">2.82843</span>        <span class="mf">0.27</span>
           <span class="mi">1</span>          <span class="mf">3.53553</span>        <span class="mf">0.77</span>
           <span class="mi">1</span>          <span class="mf">4.24264</span>        <span class="mf">3.07</span>
   <span class="n">Terms</span><span class="p">:</span>
     <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
     <span class="s1">&#39;standardize(x0)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
     <span class="s1">&#39;center(x1)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)]</span>
</code></pre></td></tr></table>
</div>
</div><p>因为Patsy中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须用特殊I函数将它们封装起来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">49</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;y ~ I(x0 + x1)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">50</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">50</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">I</span><span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span><span class="p">)</span>
          <span class="mi">1</span>        <span class="mf">1.01</span>
          <span class="mi">1</span>        <span class="mf">1.99</span>
          <span class="mi">1</span>        <span class="mf">3.25</span>
          <span class="mi">1</span>       <span class="o">-</span><span class="mf">0.10</span>
          <span class="mi">1</span>        <span class="mf">5.00</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;I(x0 + x1)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Patsy的patsy.builtins模块还有一些其它的内置转换。请查看线上文档。</p>
<p>分类数据有一个特殊的转换类，下面进行讲解。</p>
<h2 id="分类数据和patsy">分类数据和Patsy</h2>
<p>非数值数据可以用多种方式转换为模型设计矩阵。完整的讲解超出了本书范围，最好和统计课一起学习。</p>
<p>当你在Patsy公式中使用非数值数据，它们会默认转换为虚变量。如果有截距，会去掉一个，避免共线性：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">51</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;key1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;key2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;v1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
   <span class="o">....</span><span class="p">:</span>     <span class="s1">&#39;v2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7</span><span class="p">]</span>
   <span class="o">....</span><span class="p">:</span> <span class="p">})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">52</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;v2 ~ key1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">53</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">53</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">key1</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>
          <span class="mi">1</span>          <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;key1&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果你从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">54</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;v2 ~ key1 + 0&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">55</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">55</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">key1</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  <span class="n">key1</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="mi">1</span>        <span class="mi">0</span>
        <span class="mi">1</span>        <span class="mi">0</span>
        <span class="mi">0</span>        <span class="mi">1</span>
        <span class="mi">0</span>        <span class="mi">1</span>
        <span class="mi">1</span>        <span class="mi">0</span>
        <span class="mi">0</span>        <span class="mi">1</span>
        <span class="mi">1</span>        <span class="mi">0</span>
        <span class="mi">0</span>        <span class="mi">1</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;key1&#39;</span> <span class="p">(</span><span class="n">columns</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>使用C函数，数值列可以截取为分类量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">56</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;v2 ~ C(key2)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">57</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">57</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">C</span><span class="p">(</span><span class="n">key2</span><span class="p">)[</span><span class="n">T</span><span class="o">.</span><span class="mi">1</span><span class="p">]</span>
          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>             <span class="mi">1</span>
          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>             <span class="mi">1</span>
          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>             <span class="mi">1</span>
          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>             <span class="mi">0</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;C(key2)&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>当你在模型中使用多个分类名，事情就会变复杂，因为会包括key1:key2形式的相交部分，它可以用在方差（ANOVA）模型分析中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">58</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;key2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;key2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;zero&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">})</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">59</span><span class="p">]:</span> <span class="n">data</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">59</span><span class="p">]:</span> 
  <span class="n">key1</span>  <span class="n">key2</span>  <span class="n">v1</span>   <span class="n">v2</span>
<span class="mi">0</span>    <span class="n">a</span>  <span class="n">zero</span>   <span class="mi">1</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="mi">1</span>    <span class="n">a</span>   <span class="n">one</span>   <span class="mi">2</span>  <span class="mf">0.0</span>
<span class="mi">2</span>    <span class="n">b</span>  <span class="n">zero</span>   <span class="mi">3</span>  <span class="mf">2.5</span>
<span class="mi">3</span>    <span class="n">b</span>   <span class="n">one</span>   <span class="mi">4</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="mi">4</span>    <span class="n">a</span>  <span class="n">zero</span>   <span class="mi">5</span>  <span class="mf">4.0</span>
<span class="mi">5</span>    <span class="n">b</span>   <span class="n">one</span>   <span class="mi">6</span> <span class="o">-</span><span class="mf">1.2</span>
<span class="mi">6</span>    <span class="n">a</span>  <span class="n">zero</span>   <span class="mi">7</span>  <span class="mf">0.2</span>
<span class="mi">7</span>    <span class="n">b</span>  <span class="n">zero</span>   <span class="mi">8</span> <span class="o">-</span><span class="mf">1.7</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">60</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;v2 ~ key1 + key2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">61</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">61</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">key1</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>  <span class="n">key2</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">zero</span><span class="p">]</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">1</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;key1&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;key2&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">62</span><span class="p">]:</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span><span class="s1">&#39;v2 ~ key1 + key2 + key1:key2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">63</span><span class="p">]:</span> <span class="n">X</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">63</span><span class="p">]:</span> 
<span class="n">DesignMatrix</span> <span class="k">with</span> <span class="n">shape</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
  <span class="n">Intercept</span>  <span class="n">key1</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>  <span class="n">key2</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">zero</span><span class="p">]</span>
<span class="n">key1</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">b</span><span class="p">]:</span><span class="n">key2</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">zero</span><span class="p">]</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">0</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">1</span>                       <span class="mi">1</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">0</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">0</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">0</span>             <span class="mi">1</span>                       <span class="mi">0</span>
          <span class="mi">1</span>          <span class="mi">1</span>             <span class="mi">1</span>                       <span class="mi">1</span>
  <span class="n">Terms</span><span class="p">:</span>
    <span class="s1">&#39;Intercept&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s1">&#39;key1&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;key2&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">2</span><span class="p">)</span>
    <span class="s1">&#39;key1:key2&#39;</span> <span class="p">(</span><span class="n">column</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Patsy提供转换分类数据的其它方法，包括以特定顺序转换。请参阅线上文档。</p>
<h1 id="133-statsmodels介绍">13.3 statsmodels介绍</h1>
<p>statsmodels是Python进行拟合多种统计模型、进行统计试验和数据探索可视化的库。Statsmodels包含许多经典的统计方法，但没有贝叶斯方法和机器学习模型。</p>
<p>statsmodels包含的模型有：</p>
<ul>
<li>线性模型，广义线性模型和健壮线性模型</li>
<li>线性混合效应模型</li>
<li>方差（ANOVA）方法分析</li>
<li>时间序列过程和状态空间模型</li>
<li>广义矩估计</li>
</ul>
<p>下面，我会使用一些基本的statsmodels工具，探索Patsy公式和pandasDataFrame对象如何使用模型接口。</p>
<h2 id="估计线性模型">估计线性模型</h2>
<p>statsmodels有多种线性回归模型，包括从基本（比如普通最小二乘）到复杂（比如迭代加权最小二乘法）的。</p>
<p>statsmodels的线性模型有两种不同的接口：基于数组和基于公式。它们可以通过API模块引入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="kn">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">as</span> <span class="nn">smf</span>
</code></pre></td></tr></table>
</div>
</div><p>为了展示它们的使用方法，我们从一些随机数据生成一个线性模型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
    <span class="k">return</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># For reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">dnorm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">),</span>
          <span class="n">dnorm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">),</span>
          <span class="n">dnorm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)]</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">dnorm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span>
</code></pre></td></tr></table>
</div>
</div><p>这里，我使用了“真实”模型和可知参数beta。此时，dnorm可用来生成正态分布数据，带有特定均值和方差。现在有：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">66</span><span class="p">]:</span> <span class="n">X</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">66</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.1295</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2128</span><span class="p">,</span>  <span class="mf">0.5042</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">0.3029</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4357</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2542</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.3285</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0253</span><span class="p">,</span>  <span class="mf">0.1384</span><span class="p">],</span>
       <span class="p">[</span><span class="o">-</span><span class="mf">0.3515</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7196</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2582</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.2433</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3738</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5226</span><span class="p">]])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">y</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">67</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">0.4279</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6735</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0909</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4895</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1289</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>像之前Patsy看到的，线性模型通常要拟合一个截距。sm.add_constant函数可以添加一个截距的列到现存的矩阵：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">68</span><span class="p">]:</span> <span class="n">X_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">69</span><span class="p">]:</span> <span class="n">X_model</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">69</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span>    <span class="p">,</span> <span class="o">-</span><span class="mf">0.1295</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2128</span><span class="p">,</span>  <span class="mf">0.5042</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>    <span class="p">,</span>  <span class="mf">0.3029</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4357</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2542</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>    <span class="p">,</span> <span class="o">-</span><span class="mf">0.3285</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0253</span><span class="p">,</span>  <span class="mf">0.1384</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>    <span class="p">,</span> <span class="o">-</span><span class="mf">0.3515</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7196</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2582</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span>    <span class="p">,</span>  <span class="mf">1.2433</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3738</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5226</span><span class="p">]])</span>
</code></pre></td></tr></table>
</div>
</div><p>sm.OLS类可以拟合一个普通最小二乘回归：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">70</span><span class="p">]:</span> <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这个模型的fit方法返回了一个回归结果对象，它包含估计的模型参数和其它内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">71</span><span class="p">]:</span> <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">72</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">0.1783</span><span class="p">,</span>  <span class="mf">0.223</span> <span class="p">,</span>  <span class="mf">0.501</span> <span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>对结果使用summary方法可以打印模型的详细诊断结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">73</span><span class="p">]:</span> <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="n">OLS</span> <span class="n">Regression</span> <span class="n">Results</span>                            
<span class="o">==============================================================================</span>
<span class="n">Dep</span><span class="o">.</span> <span class="n">Variable</span><span class="p">:</span>                      <span class="n">y</span>   <span class="n">R</span><span class="o">-</span><span class="n">squared</span><span class="p">:</span>                       <span class="mf">0.430</span>
<span class="n">Model</span><span class="p">:</span>                            <span class="n">OLS</span>   <span class="n">Adj</span><span class="o">.</span> <span class="n">R</span><span class="o">-</span><span class="n">squared</span><span class="p">:</span>                  <span class="mf">0.413</span>
<span class="n">Method</span><span class="p">:</span>                 <span class="n">Least</span> <span class="n">Squares</span>   <span class="n">F</span><span class="o">-</span><span class="n">statistic</span><span class="p">:</span>                     <span class="mf">24.42</span>
<span class="n">Date</span><span class="p">:</span>                <span class="n">Mon</span><span class="p">,</span> <span class="mi">25</span> <span class="n">Sep</span> <span class="mi">2017</span>   <span class="n">Prob</span> <span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">statistic</span><span class="p">):</span>           <span class="mf">7.44e-12</span>
<span class="n">Time</span><span class="p">:</span>                        <span class="mi">14</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">15</span>   <span class="n">Log</span><span class="o">-</span><span class="n">Likelihood</span><span class="p">:</span>                <span class="o">-</span><span class="mf">34.305</span>
<span class="n">No</span><span class="o">.</span> <span class="n">Observations</span><span class="p">:</span>                 <span class="mi">100</span>   <span class="n">AIC</span><span class="p">:</span>                             <span class="mf">74.61</span>
<span class="n">Df</span> <span class="n">Residuals</span><span class="p">:</span>                      <span class="mi">97</span>   <span class="n">BIC</span><span class="p">:</span>                             <span class="mf">82.42</span>
<span class="n">Df</span> <span class="n">Model</span><span class="p">:</span>                           <span class="mi">3</span>                                         
<span class="n">Covariance</span> <span class="n">Type</span><span class="p">:</span>            <span class="n">nonrobust</span>                                         
<span class="o">==============================================================================</span>
                 <span class="n">coef</span>    <span class="n">std</span> <span class="n">err</span>          <span class="n">t</span>      <span class="n">P</span><span class="o">&gt;|</span><span class="n">t</span><span class="o">|</span>      <span class="p">[</span><span class="mf">0.025</span>      <span class="mf">0.975</span><span class="p">]</span>
<span class="o">------------------------------------------------------------------------------</span>
<span class="n">x1</span>             <span class="mf">0.1783</span>      <span class="mf">0.053</span>      <span class="mf">3.364</span>      <span class="mf">0.001</span>       <span class="mf">0.073</span>       <span class="mf">0.283</span>
<span class="n">x2</span>             <span class="mf">0.2230</span>      <span class="mf">0.046</span>      <span class="mf">4.818</span>      <span class="mf">0.000</span>       <span class="mf">0.131</span>       <span class="mf">0.315</span>
<span class="n">x3</span>             <span class="mf">0.5010</span>      <span class="mf">0.080</span>      <span class="mf">6.237</span>      <span class="mf">0.000</span>       <span class="mf">0.342</span>       <span class="mf">0.660</span>
<span class="o">==============================================================================</span>
<span class="n">Omnibus</span><span class="p">:</span>                        <span class="mf">4.662</span>   <span class="n">Durbin</span><span class="o">-</span><span class="n">Watson</span><span class="p">:</span>                   <span class="mf">2.201</span>
<span class="n">Prob</span><span class="p">(</span><span class="n">Omnibus</span><span class="p">):</span>                  <span class="mf">0.097</span>   <span class="n">Jarque</span><span class="o">-</span><span class="n">Bera</span> <span class="p">(</span><span class="n">JB</span><span class="p">):</span>                <span class="mf">4.098</span>
<span class="n">Skew</span><span class="p">:</span>                           <span class="mf">0.481</span>   <span class="n">Prob</span><span class="p">(</span><span class="n">JB</span><span class="p">):</span>                        <span class="mf">0.129</span>
<span class="n">Kurtosis</span><span class="p">:</span>                       <span class="mf">3.243</span>   <span class="n">Cond</span><span class="o">.</span> <span class="n">No</span><span class="o">.</span>
<span class="mf">1.74</span>
<span class="o">==============================================================================</span>
<span class="n">Warnings</span><span class="p">:</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">Standard</span> <span class="n">Errors</span> <span class="n">assume</span> <span class="n">that</span> <span class="n">the</span> <span class="n">covariance</span> <span class="n">matrix</span> <span class="n">of</span> <span class="n">the</span> <span class="n">errors</span> <span class="ow">is</span> <span class="n">correctly</span> 
<span class="n">specified</span><span class="o">.</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的参数名为通用名x1, x2等等。假设所有的模型参数都在一个DataFrame中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">74</span><span class="p">]:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;col0&#39;</span><span class="p">,</span> <span class="s1">&#39;col1&#39;</span><span class="p">,</span> <span class="s1">&#39;col2&#39;</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">75</span><span class="p">]:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">76</span><span class="p">]:</span> <span class="n">data</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">76</span><span class="p">]:</span> 
       <span class="n">col0</span>      <span class="n">col1</span>      <span class="n">col2</span>         <span class="n">y</span>
<span class="mi">0</span> <span class="o">-</span><span class="mf">0.129468</span> <span class="o">-</span><span class="mf">1.212753</span>  <span class="mf">0.504225</span>  <span class="mf">0.427863</span>
<span class="mi">1</span>  <span class="mf">0.302910</span> <span class="o">-</span><span class="mf">0.435742</span> <span class="o">-</span><span class="mf">0.254180</span> <span class="o">-</span><span class="mf">0.673480</span>
<span class="mi">2</span> <span class="o">-</span><span class="mf">0.328522</span> <span class="o">-</span><span class="mf">0.025302</span>  <span class="mf">0.138351</span> <span class="o">-</span><span class="mf">0.090878</span>
<span class="mi">3</span> <span class="o">-</span><span class="mf">0.351475</span> <span class="o">-</span><span class="mf">0.719605</span> <span class="o">-</span><span class="mf">0.258215</span> <span class="o">-</span><span class="mf">0.489494</span>
<span class="mi">4</span>  <span class="mf">1.243269</span> <span class="o">-</span><span class="mf">0.373799</span> <span class="o">-</span><span class="mf">0.522629</span> <span class="o">-</span><span class="mf">0.128941</span>
</code></pre></td></tr></table>
</div>
</div><p>现在，我们使用statsmodels的公式API和Patsy的公式字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">77</span><span class="p">]:</span> <span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;y ~ col0 + col1 + col2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">78</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">78</span><span class="p">]:</span> 
<span class="n">Intercept</span>    <span class="mf">0.033559</span>
<span class="n">col0</span>         <span class="mf">0.176149</span>
<span class="n">col1</span>         <span class="mf">0.224826</span>
<span class="n">col2</span>         <span class="mf">0.514808</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">79</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">tvalues</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">79</span><span class="p">]:</span> 
<span class="n">Intercept</span>    <span class="mf">0.952188</span>
<span class="n">col0</span>         <span class="mf">3.319754</span>
<span class="n">col1</span>         <span class="mf">4.850730</span>
<span class="n">col2</span>         <span class="mf">6.303971</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</code></pre></td></tr></table>
</div>
</div><p>观察下statsmodels是如何返回Series结果的，附带有DataFrame的列名。当使用公式和pandas对象时，我们不需要使用add_constant。</p>
<p>给出一个样本外数据，你可以根据估计的模型参数计算预测值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">80</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">80</span><span class="p">]:</span> 
<span class="mi">0</span>   <span class="o">-</span><span class="mf">0.002327</span>
<span class="mi">1</span>   <span class="o">-</span><span class="mf">0.141904</span>
<span class="mi">2</span>    <span class="mf">0.041226</span>
<span class="mi">3</span>   <span class="o">-</span><span class="mf">0.323070</span>
<span class="mi">4</span>   <span class="o">-</span><span class="mf">0.100535</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</code></pre></td></tr></table>
</div>
</div><p>statsmodels的线性模型结果还有其它的分析、诊断和可视化工具。除了普通最小二乘模型，还有其它的线性模型。</p>
<h2 id="估计时间序列过程">估计时间序列过程</h2>
<p>statsmodels的另一模型类是进行时间序列分析，包括自回归过程、卡尔曼滤波和其它态空间模型，和多元自回归模型。</p>
<p>用自回归结构和噪声来模拟一些时间序列数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">init_x</span> <span class="o">=</span> <span class="mi">4</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">init_x</span><span class="p">,</span> <span class="n">init_x</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">b0</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">dnorm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">new_x</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_x</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这个数据有AR(2)结构（两个延迟），参数是0.8和-0.4。拟合AR模型时，你可能不知道滞后项的个数，因此可以用较多的滞后量来拟合这个模型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">82</span><span class="p">]:</span> <span class="n">MAXLAGS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">83</span><span class="p">]:</span> <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">AR</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">84</span><span class="p">]:</span> <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">MAXLAGS</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>结果中的估计参数首先是截距，其次是前两个参数的估计值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">85</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.0062</span><span class="p">,</span>  <span class="mf">0.7845</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4085</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0136</span><span class="p">,</span>  <span class="mf">0.015</span> <span class="p">,</span>  <span class="mf">0.0143</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>更多的细节以及如何解释结果超出了本书的范围，可以通过statsmodels文档学习更多。</p>
<h1 id="134-scikit-learn介绍">13.4 scikit-learn介绍</h1>
<p>scikit-learn是一个广泛使用、用途多样的Python机器学习库。它包含多种标准监督和非监督机器学习方法和模型选择和评估、数据转换、数据加载和模型持久化工具。这些模型可以用于分类、聚合、预测和其它任务。</p>
<p>机器学习方面的学习和应用scikit-learn和TensorFlow解决实际问题的线上和纸质资料很多。本节中，我会简要介绍scikit-learn API的风格。</p>
<p>写作此书的时候，scikit-learn并没有和pandas深度结合，但是有些第三方包在开发中。尽管如此，pandas非常适合在模型拟合前处理数据集。</p>
<p>举个例子，我用一个Kaggle竞赛的经典数据集，关于泰坦尼克号乘客的生还率。我们用pandas加载测试和训练数据集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">86</span><span class="p">]:</span> <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/titanic/train.csv&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">87</span><span class="p">]:</span> <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/titanic/test.csv&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">88</span><span class="p">]:</span> <span class="n">train</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">88</span><span class="p">]:</span> 
   <span class="n">PassengerId</span>  <span class="n">Survived</span>  <span class="n">Pclass</span>  \
<span class="mi">0</span>            <span class="mi">1</span>         <span class="mi">0</span>       <span class="mi">3</span>   
<span class="mi">1</span>            <span class="mi">2</span>         <span class="mi">1</span>       <span class="mi">1</span>   
<span class="mi">2</span>            <span class="mi">3</span>         <span class="mi">1</span>       <span class="mi">3</span>   
<span class="mi">3</span>            <span class="mi">4</span>         <span class="mi">1</span>       <span class="mi">1</span>   
                                                <span class="n">Name</span>     <span class="n">Sex</span>   <span class="n">Age</span>  <span class="n">SibSp</span>  \
<span class="mi">0</span>                            <span class="n">Braund</span><span class="p">,</span> <span class="n">Mr</span><span class="o">.</span> <span class="n">Owen</span> <span class="n">Harris</span>    <span class="n">male</span>  <span class="mf">22.0</span>      <span class="mi">1</span>   
<span class="mi">1</span>  <span class="n">Cumings</span><span class="p">,</span> <span class="n">Mrs</span><span class="o">.</span> <span class="n">John</span> <span class="n">Bradley</span> <span class="p">(</span><span class="n">Florence</span> <span class="n">Briggs</span> <span class="n">Th</span><span class="o">...</span>  <span class="n">female</span>  <span class="mf">38.0</span>      <span class="mi">1</span>   
<span class="mi">2</span>                             <span class="n">Heikkinen</span><span class="p">,</span> <span class="n">Miss</span><span class="o">.</span> <span class="n">Laina</span>  <span class="n">female</span>  <span class="mf">26.0</span>      <span class="mi">0</span>   
<span class="mi">3</span>       <span class="n">Futrelle</span><span class="p">,</span> <span class="n">Mrs</span><span class="o">.</span> <span class="n">Jacques</span> <span class="n">Heath</span> <span class="p">(</span><span class="n">Lily</span> <span class="n">May</span> <span class="n">Peel</span><span class="p">)</span>  <span class="n">female</span>  <span class="mf">35.0</span>      <span class="mi">1</span>   
   <span class="n">Parch</span>            <span class="n">Ticket</span>     <span class="n">Fare</span> <span class="n">Cabin</span> <span class="n">Embarked</span>  
<span class="mi">0</span>      <span class="mi">0</span>         <span class="n">A</span><span class="o">/</span><span class="mi">5</span> <span class="mi">21171</span>   <span class="mf">7.2500</span>   <span class="n">NaN</span>        <span class="n">S</span>  
<span class="mi">1</span>      <span class="mi">0</span>          <span class="n">PC</span> <span class="mi">17599</span>  <span class="mf">71.2833</span>   <span class="n">C85</span>        <span class="n">C</span>  
<span class="mi">2</span>      <span class="mi">0</span>  <span class="n">STON</span><span class="o">/</span><span class="n">O2</span><span class="o">.</span> <span class="mi">3101282</span>   <span class="mf">7.9250</span>   <span class="n">NaN</span>        <span class="n">S</span>  
<span class="mi">3</span>      <span class="mi">0</span>            <span class="mi">113803</span>  <span class="mf">53.1000</span>  <span class="n">C123</span>        <span class="n">S</span>
</code></pre></td></tr></table>
</div>
</div><p>statsmodels和scikit-learn通常不能接收缺失数据，因此我们要查看列是否包含缺失值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">89</span><span class="p">]:</span> <span class="n">train</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">89</span><span class="p">]:</span> 
<span class="n">PassengerId</span>      <span class="mi">0</span>
<span class="n">Survived</span>         <span class="mi">0</span>
<span class="n">Pclass</span>           <span class="mi">0</span>
<span class="n">Name</span>             <span class="mi">0</span>
<span class="n">Sex</span>              <span class="mi">0</span>
<span class="n">Age</span>            <span class="mi">177</span>
<span class="n">SibSp</span>            <span class="mi">0</span>
<span class="n">Parch</span>            <span class="mi">0</span>
<span class="n">Ticket</span>           <span class="mi">0</span>
<span class="n">Fare</span>             <span class="mi">0</span>
<span class="n">Cabin</span>          <span class="mi">687</span>
<span class="n">Embarked</span>         <span class="mi">2</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">90</span><span class="p">]:</span> <span class="n">test</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">90</span><span class="p">]:</span> 
<span class="n">PassengerId</span>      <span class="mi">0</span>
<span class="n">Pclass</span>           <span class="mi">0</span>
<span class="n">Name</span>             <span class="mi">0</span>
<span class="n">Sex</span>              <span class="mi">0</span>
<span class="n">Age</span>             <span class="mi">86</span>
<span class="n">SibSp</span>            <span class="mi">0</span>
<span class="n">Parch</span>            <span class="mi">0</span>
<span class="n">Ticket</span>           <span class="mi">0</span>
<span class="n">Fare</span>             <span class="mi">1</span>
<span class="n">Cabin</span>          <span class="mi">327</span>
<span class="n">Embarked</span>         <span class="mi">0</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</code></pre></td></tr></table>
</div>
</div><p>在统计和机器学习的例子中，根据数据中的特征，一个典型的任务是预测乘客能否生还。模型现在训练数据集中拟合，然后用样本外测试数据集评估。</p>
<p>我想用年龄作为预测值，但是它包含缺失值。缺失数据补全的方法有多种，我用的是一种简单方法，用训练数据集的中位数补全两个表的空值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">91</span><span class="p">]:</span> <span class="n">impute_value</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">92</span><span class="p">]:</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">impute_value</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">93</span><span class="p">]:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">impute_value</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>现在我们需要指定模型。我增加了一个列IsFemale，作为“Sex”列的编码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">94</span><span class="p">]:</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;IsFemale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">95</span><span class="p">]:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;IsFemale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，我们确定一些模型变量，并创建NumPy数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">96</span><span class="p">]:</span> <span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pclass&#39;</span><span class="p">,</span> <span class="s1">&#39;IsFemale&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">97</span><span class="p">]:</span> <span class="n">X_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">predictors</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">98</span><span class="p">]:</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">predictors</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">99</span><span class="p">]:</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">100</span><span class="p">]:</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">100</span><span class="p">]:</span> 
<span class="n">array</span><span class="p">([[</span>  <span class="mf">3.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">22.</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">1.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">,</span>  <span class="mf">38.</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">3.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">,</span>  <span class="mf">26.</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">1.</span><span class="p">,</span>   <span class="mf">1.</span><span class="p">,</span>  <span class="mf">35.</span><span class="p">],</span>
       <span class="p">[</span>  <span class="mf">3.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span>  <span class="mf">35.</span><span class="p">]])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">y_train</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">101</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>我不能保证这是一个好模型，但它的特征都符合。我们用scikit-learn的LogisticRegression模型，创建一个模型实例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">102</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">103</span><span class="p">]:</span> <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>与statsmodels类似，我们可以用模型的fit方法，将它拟合到训练数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">104</span><span class="p">]:</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">104</span><span class="p">]:</span> 
<span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fit_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
          <span class="n">intercept_scaling</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>现在，我们可以用model.predict，对测试数据进行预测：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">105</span><span class="p">]:</span> <span class="n">y_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">106</span><span class="p">]:</span> <span class="n">y_predict</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">106</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>如果你有测试数据集的真是值，你可以计算准确率或其它错误度量值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">y_true</span> <span class="o">==</span> <span class="n">y_predict</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>在实际中，模型训练经常有许多额外的复杂因素。许多模型有可以调节的参数，有些方法（比如交叉验证）可以用来进行参数调节，避免对训练数据过拟合。这通常可以提高预测性或对新数据的健壮性。</p>
<p>交叉验证通过分割训练数据来模拟样本外预测。基于模型的精度得分（比如均方差），可以对模型参数进行网格搜索。有些模型，如logistic回归，有内置的交叉验证的估计类。例如，logisticregressioncv类可以用一个参数指定网格搜索对模型的正则化参数C的粒度：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">107</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegressionCV</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">108</span><span class="p">]:</span> <span class="n">model_cv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">109</span><span class="p">]:</span> <span class="n">model_cv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">109</span><span class="p">]:</span> 
<span class="n">LogisticRegressionCV</span><span class="p">(</span><span class="n">Cs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
           <span class="n">fit_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">intercept_scaling</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">refit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>要手动进行交叉验证，你可以使用cross_val_score帮助函数，它可以处理数据分割。例如，要交叉验证我们的带有四个不重叠训练数据的模型，可以这样做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">110</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">111</span><span class="p">]:</span> <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">112</span><span class="p">]:</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="n">scores</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">113</span><span class="p">]:</span> <span class="n">array</span><span class="p">([</span> <span class="mf">0.7723</span><span class="p">,</span>  <span class="mf">0.8027</span><span class="p">,</span>  <span class="mf">0.7703</span><span class="p">,</span>  <span class="mf">0.7883</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p>默认的评分指标取决于模型本身，但是可以明确指定一个评分。交叉验证过的模型需要更长时间来训练，但会有更高的模型性能。</p>
<h1 id="135-继续学习">13.5 继续学习</h1>
<p>我只是介绍了一些Python建模库的表面内容，现在有越来越多的框架用于各种统计和机器学习，它们都是用Python或Python用户界面实现的。</p>
<p>这本书的重点是数据规整，有其它的书是关注建模和数据科学工具的。其中优秀的有：</p>
<ul>
<li>Andreas Mueller and Sarah Guido (O’Reilly)的 《Introduction to Machine Learning with Python》</li>
<li>Jake VanderPlas (O’Reilly)的 《Python Data Science Handbook》</li>
<li>Joel Grus (O’Reilly) 的 《Data Science from Scratch: First Principles》</li>
<li>Sebastian Raschka (Packt Publishing) 的《Python Machine Learning》</li>
<li>Aurélien Géron (O’Reilly) 的《Hands-On Machine Learning with Scikit-Learn and TensorFlow》</li>
</ul>
<p>虽然书是学习的好资源，但是随着底层开源软件的发展，书的内容会过时。最好是不断熟悉各种统计和机器学习框架的文档，学习最新的功能和API。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Yang Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        0001-01-01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/hugo-blog/post/%E7%AC%AC12%E7%AB%A0-pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default"></span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/hugo-blog/post/%E7%AC%AC14%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/">
            <span class="next-text nav-default"></span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://space.bilibili.com/151549281/favlist" class="iconfont icon-bilibili" title="bilibili"></a>
      <a href="https://www.douban.com/people/174007085/" class="iconfont icon-douban" title="douban"></a>
      <a href="jwzzy19950225@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/xy19950225" class="iconfont icon-github" title="github"></a>
  <a href="https://xy19950225.github.io/hugo-blog/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/hugo-blog/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/hugo-blog/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020<span class="heart"><i class="iconfont icon-heart"></i></span><span>Yang Xu</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script><script></script><script src="https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js" integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js" integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/hugo-blog/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>








</body>
</html>
