---
title: "[笔记] SQL 窗口函数总结"
date: 2020-10-01
lastmod: 2020-10-08
draft: false
tags: ["计算机", "数据库", "SQL"]
categories: ["学习"]

---



> **重点**
>
> -  窗口函数和聚合函数的区别
>
> -   `PARTITION BY` 和 `ORDER BY` 关键字

## 1. 窗口函数的简介



**窗口函数**：也称为 OLAP 函数，将表以窗口为单位进行分割，并在其中进行排序

**OLAP** ： OnLine Analytical Processing 的简称，指[**联机分析处理**](https://zh.wikipedia.org/wiki/%E7%B7%9A%E4%B8%8A%E5%88%86%E6%9E%90%E8%99%95%E7%90%86) 

**小结**：窗口函数就是为了实现 OLAP 而添加的标准 SQL 功能



> **更多：`MySQL 8.0` 开始支持窗口函数**
>
> 了解 MySQL 窗口函数  [小丁的个人博客](https://tding.top/archives/c6e31643.html) 
>
> 了解 MySQL 8.0 新特性 [官方文档](https://dev.mysql.com/doc/refman/8.0/en/)



## 2. 窗口函数的语法



**基本语法**



```SQL
# [] 中的内容可以省略
<窗口函数> OVER ([PARTITION BY <列清单>] ORDER BY <排序用列清单>)
```



**小结**

- 窗口函数兼具分组和排序两种功能
- 通过 `PARTITION BY` 分组后的记录集合称为“窗口”
- `PARTITION BY` 设定排序的对象范围
- `ORDER BY` 指定按照哪一列、何种顺序进行排序



**思考**

 `PARTITION BY` 和 `GROUP BY` 的区别 [点击这里](https://www.itranslater.com/qa/details/2108912919936238592)

`PARTITION BY` 返回分组里的每一行数据

`GROUP BY` 返回分组里的仅一行数据




## 3. 窗口函数的分类



按照功能差异可将窗口函数分为聚合窗口函数和专门窗口函数（如排序窗口函数）



### **3.1 聚合窗口函数**



> 以**当前记录**作为基准进行**累计**，是聚合窗口函数的最大特征



**代码示例**



```SQL
# 指定 “最靠近的 3 行” 作为汇总对象
SELECT product_id, product_name, sale_price,
	AVG (sale_price) OVER (ORDER BY product_id ROWS 2 PRECEDING) AS moving_avg
FROM Product;
```



**执行结果**




| product_id | product_name | sale_price | moving_avg |
| ---------: | ------------ | ---------: | ---------: |
|       0001 | T恤衫        |       1000 |       1000 |
|       0002 | 打孔器       |        500 |        750 |
|       0003 | 运动T恤      |       4000 |       1833 |
|       0004 | 菜刀         |       3000 |       2500 |
|       0005 | 高压锅       |       6800 |       4600 |
|       0006 | 叉子         |        500 |       3433 |
|       0007 | 擦菜板       |        880 |       2726 |
|       0008 | 圆珠笔       |        100 |        493 |



**代码示例**



```SQL
# 将当前记录的前后行作为汇总对象
SELECT product_id, product_name, sale_price,
	AVG(sale_price) OVER(ORDER BY product_id 
	ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS moving_avg 
FROM Product;
```



**执行结果**



| product_id | product_name | sale_price | moving_avg |
| ---------: | ------------ | ---------: | ---------: |
|       0001 | T恤衫        |       1000 |        750 |
|       0002 | 打孔器       |        500 |       1833 |
|       0003 | 运动T恤      |       4000 |       2500 |
|       0004 | 菜刀         |       3000 |       4600 |
|       0005 | 高压锅       |       6800 |       3433 |
|       0006 | 叉子         |        500 |       2726 |
|       0007 | 擦菜板       |        880 |        493 |
|       0008 | 圆珠笔       |        100 |        490 |



> **小结**
>
> - **`ROWS`** 指定框架
> - **`PRECEDING`** 将框架指定为“截止到之**前** ~ 行”
> - **`FOLLOWING`**  将框架指定为“截止到之**后** ~ 行”
>



### **3.2 排序窗口函数**



**代码示例**



```SQL
SELECT product_name, product_type, sale_price,
	RANK () OVER (ORDER BY sale_price) AS ranking,
	DENSE_RANK () OVER (ORDER BY sale_price) AS dense_ranking,
	ROW_NUMBER () OVER (ORDER BY sale_price) AS row_num
FROM Product;
```



**执行结果**



| product_name | product_type | sale_price | ranking | dense_ranking | row_num |
| ------------ | ------------ | ---------: | ------: | ------------: | ------: |
| 圆珠笔       | 办公用品     |        100 |       1 |             1 |       1 |
| 叉子         | 厨房用具     |        500 |       2 |             2 |       2 |
| 打孔器       | 办公用品     |        500 |       2 |             2 |       3 |
| 擦菜板       | 厨房用具     |        880 |       4 |             3 |       4 |
| T恤衫        | 衣服         |       1000 |       5 |             4 |       5 |
| 菜刀         | 厨房用具     |       3000 |       6 |             5 |       6 |
| 运动T恤      | 衣服         |       4000 |       7 |             6 |       7 |
| 高压锅       | 厨房用具     |       6800 |       8 |             7 |       8 |



> **小结**：上述示例已经清晰表明了 `RANK、DENSE_RANK、ROW_NUMBER` 三者间的区别，在此不做赘述



## 4. 窗口函数的应用

> 使用 Hive SQL 的窗口函数进行商务数据分析 [Jmx's Blog](https://jiamaoxiang.top/2020/09/07/%E4%BD%BF%E7%94%A8Hive-SQL%E7%9A%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%95%86%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/)

通过具体的分析案例，可以加深对 SQL 窗口函数的理解

- 需求1：收入增长
- 需求2：累计求和

- 需求3：处理重复数据

- 需求4：分组取 TopN

- 需求5：重复购买行为



## 5. 致谢



> 《SQL基础教程（第2版）》- MICK (作者) 孙淼 , 罗勇 (译者) 



<img src="https://file.ituring.com.cn/ScreenShow/1712477631b07b9f5895" alt="img" style="zoom:50%;" />


